services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tripz
    restart: unless-stopped
    ports:
      - '80:3000'
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:///app/data/tripz.db
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://trips.local}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - ADMIN_TEMP_EMAIL=${ADMIN_TEMP_EMAIL}
      - ADMIN_TEMP_PASSWORD=${ADMIN_TEMP_PASSWORD}
    volumes:
      # Persist SQLite database using named volume
      # This ensures data persists across container restarts and rebuilds
      - type: volume
        source: tripz-data
        target: /app/data
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:3000/api/auth/providers']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  tripz-data:
    driver: local
